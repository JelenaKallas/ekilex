<!DOCTYPE html>
<html lang="et" xmlns:th="http://www.thymeleaf.org">
<head th:replace="common :: common_header(~{::title},~{::links})">
<title th:text="#{term.search.title}">EKILEX otsing</title>
<th:block th:fragment="links">
  <script type="text/javascript" th:src="@{/view/js/ekilex-termsearch.js}"></script>
</th:block>
</head>
<body style="height: 100vh">
  <div class="container-fluid">
    <div class="d-flex flex-row">
      <p class="card-text">
        <a th:href="@{/}">
          <span th:text="${appData.appName + ' ' + appData.appVersion}"></span>
        </a>
      </p>
    </div>
    <div class="card mt-4">
      <div class="card-header">
        <h5 class="card-title" th:text="#{term.search.title}">Vormi otsing</h5>
      </div>
      <div class="card-body">
        <form th:action="@{/termsearch}" method="post">
          <th:block th:replace="search :: search_form('term_search')"></th:block>
          <th:block>
            <div class="form-row">
              <div class="col-auto">
                <div class="row">
                  <label class="col-auto col-form-label">Tähenduste keel:</label>
                  <div class="col-auto">
                    <select name="resultLang" class="form-control">
                      <option value="">Kõik keeled</option>
                      <option 
                          th:each="lang : ${allLanguages}"
                          th:value="${lang.code}"
                          th:selected="${lang.code == sessionBean.resultLang}"
                          th:text="${lang.value}"></option>
                    </select>
                  </div>
                </div>
              </div>
              <div class="col-1">
                &nbsp;
              </div>
              <div class="col-auto">
                <div class="row">
                  <label class="col-auto col-form-label">Ilmikute keeled:</label>
                  <div class="col-auto">
                    <div>
                      <a id="term_user_lang_wrapup" href="#term_user_lang_area" data-toggle="collapse">
                        <span th:text="${termViewUtil.composeLanguagesOrderWrapup(sessionBean.languagesOrder)}"></span>
                      </a>
                    </div>
                    <div id="term_user_lang_area" class="collapse">
                      <table class="orderable" th:data-op-code="term_user_lang">
                        <tr th:each="lang, itemStat : ${sessionBean.languagesOrder}"
                          th:data-code="${lang.code}" 
                          th:data-orderby="${itemStat.count}" 
                          th:data-index="${itemStat.index}"
                          th:data-value="${lang.value}">
                          <td>
                            <th:block th:replace="common :: ordering_buttons(${itemStat})"></th:block>
                          </td>
                          <td>
                            <div class="checkbox">
                              <input type="checkbox" name="term_user_lang_check" th:checked="${lang.selected}"/>
                            </div>
                          </td>
                          <td>
                            <span th:text="${lang.value}"></span>
                          </td>
                        </tr>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </th:block>
        </form>
      </div>
    </div>

    <div class="mt-4 float-left" th:if="${(!searchResult.resultExist) && (simpleSearchFilter != null)}">
      <span th:text="#{term.not.found}">Not found.</span>
      <button type="button" class="btn btn-success mt-2"
              data-toggle="modal" data-target="#newWordDlg">
        Lisa uus
      </button>
    </div>

    <div class="mt-4 float-left w-25" th:if="${searchResult.resultExist}" style="height: calc(100vh - 15em); overflow-y: auto;">
      <div>
        <a href="javascript:void(0);" id="show-all-btn">
          <span th:text="${'Tulemusi : ' + searchResult.resultCount}"></span>
        </a>
      </div>
      <hr />
      <table id="results" class="w-100">
        <tr th:each="termMeaning,termMeaningIter : ${searchResult.termMeanings}" style="border-bottom: 1px solid #ddd">
          <td class="w-100" style="padding: 0px">
            <div th:each="word,wordIter : ${termMeaning.wordTuples}" style="text-align: left">
              <button type="button" class="btn btn-link pt-0" th:data-id="${termMeaning.meaningId}" name="detailsBtn">
                <span th:text="${wordIter.count}"></span>
                &nbsp;
                <span th:if="${word.value != null}">
                  <span th:text="${word.value}" class="ttl">EuropeAid</span>
                  <span th:text="${word.homonymNumber}" th:if="${word.homonymNumber > 0}"></span>
                  (
                  <span th:text="${word.language}"></span>
                  )
                </span>
                <span th:if="${word.value == null}">
                  <span th:text="${word.conceptId}" class="ttl">23648236</span>
                </span>
              </button>
              <div style="position:relative; top: -10px; padding-left: 10px">
                <small>
                  <span th:each="wordDatasetCode,wordDatasetIter : ${word.datasetCodes}">
                    <span th:text="${wordDatasetCode}"></span>
                    <span th:unless="${wordDatasetIter.last}">,</span>
                  </span>
                </small>
              </div>
            </div>
          </td>
        </tr>
      </table>
    </div>
    <div id="details_div"></div>
  </div>

  <th:block th:fragment="details" th:if="${meaning != null}">
    <div th:data-id="${meaningId}" class="float-left mt-4 ml-2 pb-4" id="details_div" style="height: calc(100vh - 15em); width: 74%; overflow-y: auto;">
      <button id="refresh-details" hidden th:data-id="${meaningId}" name="detailsBtn" data-refresh></button>
      <div style="border: 1px solid #CCC; padding: 5px;">
        <div>
          <div th:if="${meaning.processStateCode != null}">
            <span class="lbl">Olek</span>
            <span th:text="${meaning.processStateCode}"></span>
          </div>
          <div>
            <span class="lbl">Valdkonnad</span>
            <span th:each="classif,classifIter : ${meaning.domains}" class="hidden-buttons" th:if="${not #lists.isEmpty(meaning.domains)}">
              <span
                th:data-id="${meaningId}"
                th:data-op-code="meaning_domain"
                th:data-value="${classif.toIdString()}"
                th:name="${classifIter.index} + '_meaning_domain'"
                th:text="${classif.code}"></span>
              <th:block th:unless="${classif.code == classif.value}">
                -
                <span th:text="${classif.value}"></span>
              </th:block>
              <button type="button" class="btn badge badge-primary"
                      th:title="Muuda"
                      onclick="openSelectDlg(this)"
                      data-toggle="modal" data-target="#meaningDomainDlg"
                      th:data-target-elem="${classifIter.index} + '_meaning_domain'">
                <i class="fa fa-caret-down" aria-hidden="true"></i>
              </button>
              <button type="button" class="btn badge badge-warning"
                      th:data-target-elem="${classifIter.index} + '_meaning_domain'"
                      data-toggle="delete-confirmation" data-placement="right">
                <i class="fa fa-remove" aria-hidden="true"></i>
              </button>
              <span th:unless="${classifIter.last}">,</span>
            </span>
            <button type="button" class="btn badge badge-success" title="Lisa uus"
                    th:data-id="${meaningId}"
                    onclick="openLexemeClassifiersDlg(this)"
                    data-toggle="modal" data-target="#lexemeClassifiersDlg">
              <i class="fa fa-plus" aria-hidden="true"></i>
            </button>
          </div>
          <div>
            <span class="lbl">Seletused</span>
            <button type="button" class="btn badge badge-success" title="Lisa uus"
                    th:data-id="${meaningId}"
                    onclick="openAddDlg(this)"
                    data-toggle="modal" data-target="#addNewDefinitionDlg">
              <i class="fa fa-plus" aria-hidden="true"></i>
            </button>
            <ul>
              <li th:each="definition : ${meaning.definitions}" th:if="${termViewUtil.isSelectedLang(definition.lang,sessionBean.languagesOrder)}">
                <div class="hidden-buttons">
                  <span th:name="${definition.id} + '_definition'"
                        th:data-id="${definition.id}"
                        th:data-op-code="definition"
                        th:data-value="${definition.value}"
                        th:utext="${definition.value}"></span>
                  <button type="button" class="btn badge badge-primary ml-2"
                          th:title="Muuda" th:data-target-elem="${definition.id} + '_definition'"
                          onclick="openEditDlg(this)"
                          data-toggle="modal" data-target="#editDlg">
                    <i class="fa fa-edit" aria-hidden="true"></i>
                  </button>
                  <button type="button" class="btn badge badge-warning"
                          th:data-target-elem="${definition.id} + '_definition'"
                          data-toggle="delete-confirmation" data-placement="right">
                    <i class="fa fa-remove" aria-hidden="true"></i>
                  </button>
                </div>
                <div th:unless="${not #lists.isEmpty(definition.refLinks)}">
                  []
                  <button type="button" class="btn badge badge-success" title="Lisa allikaviide"
                          th:data-id="${definition.id}"
                          th:data-op-code="defSourceRef"
                          onclick="openAddSourceRefDlg(this)"
                          data-toggle="modal" data-target="#addNewSourceRefDlg">
                    <i class="fa fa-plus" aria-hidden="true"></i>
                  </button>
                </div>
                <div th:if="${not #lists.isEmpty(definition.refLinks)}" class="hidden-buttons">
                  <span th:each="refLink : ${definition.refLinks}">
                    [
                    <a th:href="@{'/def_ref_link:' + ${refLink.id}}"
                       th:name="${refLink.id} + '_def_ref_link'"
                       th:data-id="${refLink.id}"
                       th:data-op-code="def_ref_link"
                       th:text="${refLink.value}"
                    ></a>
                    <span th:if="${refLink.name != null}">
                      <span th:text="${refLink.name}"></span>
                    </span>
                    <button type="button" class="btn badge badge-warning"
                            th:data-target-elem="${refLink.id} + '_def_ref_link'"
                            data-toggle="delete-confirmation" data-placement="right">
                      <i class="fa fa-remove" aria-hidden="true"></i>
                    </button>
                    ]
                  </span>
                  <button type="button" class="btn badge badge-success" title="Lisa allikaviide"
                          th:data-id="${definition.id}"
                          th:data-op-code="defSourceRef"
                          onclick="openAddSourceRefDlg(this)"
                          data-toggle="modal" data-target="#addNewSourceRefDlg">
                    <i class="fa fa-plus" aria-hidden="true"></i>
                  </button>
                </div>
              </li>
            </ul>
          </div>
          <div th:if="${not #lists.isEmpty(meaning.freeforms)}">
            <span class="lbl">Tähenduse atribuudid</span>
            <table>
              <tr th:each="freeform : ${meaning.freeforms}">
                <td style="vertical-align: text-top; padding-right: 1em">
                  <span th:text="${freeform.type}"></span>
                </td>
                <td th:unless="${freeform.type.toString() == 'IMAGE_FILE'}">
                  <span th:utext="${markdown.toHtml(freeform.valueText)}" th:if="${freeform.valueText != null}"></span>
                  <span th:text="${#dates.format(freeform.valueDate, 'dd.MM.yyyy HH:mm')}" th:if="${freeform.valueDate != null}"></span>
                </td>
                <td th:if="${freeform.type.toString() == 'IMAGE_FILE'}">
                  <img th:src="@{'/files/images/' + ${freeform.valueText}}"></img>
                </td>
              </tr>
            </table>
          </div>
          <div th:if="${not #lists.isEmpty(meaning.relations)}">
            <hr />
            <span class="lbl">Tähenduse seosed</span>
            <table>
              <tr th:each="relation : ${meaning.relations}">
                <td style="vertical-align: text-top; padding-right: 1em">
                  <button type="button" class="btn btn-link pt-0" th:data-id="${relation.wordId}" name="detailsBtn">
                    <span th:text="${relation.word}"></span>
                    (
                    <span th:text="${relation.wordLang}"></span>
                    )
                  </button>
                </td>
                <td>
                  <span th:text="${relation.relationTypeLabel}"></span>
                </td>
              </tr>
            </table>
          </div>
          <p />
        </div>
        <th:block th:each="lexeme,lexemeIter : ${meaning.lexemes}" th:if="${termViewUtil.isSelectedLang(lexeme.wordLang,sessionBean.languagesOrder)}">
          <div style="border: 1px solid rgba(200,200,200,0.4); padding: 5px; width: 100%" class="mt-2">
            <div>
              <span th:text="${lexeme.word}" class="ttl"></span>
              <span th:text="${lexeme.homonymNumber}"></span>
              (
              <span th:text="${lexeme.wordLang}"></span>
              )
              <span th:if="${lexeme.levels != null}">
                <small>
                  [
                  <span th:text="${lexeme.levels}"></span>
                  ]
                </small>
                &nbsp;
              </span>
              <span th:if="${lexeme.wordDisplayMorphCode != null}" th:text="${lexeme.wordDisplayMorphCode}"></span>
              <b>
                <span th:text="${lexeme.dataset}" class="float-right"></span>
              </b>
            </div>
            <div th:if="${lexeme.classifiersExist}">
              <hr />
              <div th:if="${lexeme.valueStateCode != null}">
                <span class="lbl">Väärtusolek</span>
                <span th:text="${lexeme.valueStateCode}"></span>
              </div>
              <div th:if="${lexeme.genderCode != null}">
                <span class="lbl">Sugu</span>
                <span th:text="${lexeme.genderCode}"></span>
              </div>
              <div th:if="${!#lists.isEmpty(lexeme.grammars)}">
                <span class="lbl">Grammatika</span>
                <span th:each="grammar,grammarIter : ${lexeme.grammars}">
                <span th:text="${grammar.valueText}"></span>
                <span th:unless="${grammarIter.last}">,&nbsp;</span>
              </span>
              </div>
              <div th:if="${lexeme.frequencyGroupCode != null}">
                <span class="lbl">Sagedusrühm</span>
                <span th:text="${lexeme.frequencyGroupCode}"></span>
              </div>
              <div th:if="${not #lists.isEmpty(lexeme.pos)}">
                <span class="lbl">Sõnaliik</span>
                <span th:each="classif,classifIter : ${lexeme.pos}">
                  <span th:text="${classif.code}"></span>
                  <th:block th:unless="${classif.code == classif.value}">
                    -
                    <span th:text="${classif.value}"></span>
                  </th:block>
                  <span th:unless="${classifIter.last}">,</span>
                </span>
              </div>
              <div th:if="${not #lists.isEmpty(lexeme.derivs)}">
                <span class="lbl">Tuletuskood</span>
                <span th:each="classif,classifIter : ${lexeme.derivs}">
                  <span th:text="${classif.code}"></span>
                  <th:block th:unless="${classif.code == classif.value}">
                    -
                    <span th:text="${classif.value}"></span>
                  </th:block>
                  <span th:unless="${classifIter.last}">,</span>
                </span>
              </div>
              <div th:if="${not #lists.isEmpty(lexeme.registers)}">
                <span class="lbl">Register</span>
                <span th:each="classif,classifIter : ${lexeme.registers}">
                  <span th:text="${classif.code}"></span>
                  <th:block th:unless="${classif.code == classif.value}">
                    -
                    <span th:text="${classif.value}"></span>
                  </th:block>
                  <span th:unless="${classifIter.last}">,</span>
                </span>
              </div>
            </div>
            <div>
              <hr />
              <span class="lbl">Allikaviide</span>
              <span th:each="refLink : ${lexeme.refLinks}" class="hidden-buttons">
                [
                <a th:href="@{'/lex_ref_link:' + ${refLink.id}}"
                   th:name="${refLink.id} + '_lex_ref_link'"
                   th:data-id="${refLink.id}"
                   th:data-op-code="lex_ref_link"
                   th:text="${refLink.value}"
                ></a>
                <span th:if="${refLink.name != null}">
                  <span th:text="${refLink.name}"></span>
                </span>
                <button type="button" class="btn badge badge-warning"
                        th:data-target-elem="${refLink.id} + '_lex_ref_link'"
                        data-toggle="delete-confirmation" data-placement="right">
                  <i class="fa fa-remove" aria-hidden="true"></i>
                </button>
                ]
              </span>
              <button type="button" class="btn badge badge-success" title="Lisa allikaviide"
                      th:data-id="${lexeme.lexemeId}"
                      th:data-op-code="lexSourceRef"
                      onclick="openAddSourceRefDlg(this)"
                      data-toggle="modal" data-target="#addNewSourceRefDlg">
                <i class="fa fa-plus" aria-hidden="true"></i>
              </button>
            </div>
            <hr />
            <div th:unless="${not #lists.isEmpty(lexeme.governments)}" class="mt-1">
              <span class="lbl">Kasutusnäited</span>
              <button type="button" class="btn badge badge-success" title="Lisa uus"
                      th:data-id="${lexeme.lexemeId}"
                      onclick="openAddDlg(this)"
                      data-toggle="modal" data-target="#addNewGovernmentUsageDlg">
                <i class="fa fa-plus" aria-hidden="true"></i>
              </button>
            </div>
            <div th:if="${not #lists.isEmpty(lexeme.governments)}" class="mt-1">
              <span class="lbl">Kasutusnäited</span>
              <button type="button" class="btn badge badge-success" title="Lisa uus"
                      th:data-id="${lexeme.governments.get(0).id}"
                      onclick="openAddDlg(this)"
                      data-toggle="modal" data-target="#addNewUsageDlg">
                <i class="fa fa-plus" aria-hidden="true"></i>
              </button>
              <ul>
                <th:block th:each="government,governmentIter : ${lexeme.governments}">
                  <th:block th:each="usageMeaning,usageMeaningIter : ${government.usageMeanings}">
                    <li th:each="usage : ${usageMeaning.usages}">
                      <div class="hidden-buttons">
                                  <span th:name="${usage.id} + '_usage'"
                                        th:data-id="${usage.id}"
                                        th:data-op-code="usage"
                                        th:data-value="${usage.value}"
                                        th:utext="${usage.value}"></span>
                        <span th:if="${usage.author != null}" th:text="'(' + ${usage.author} + ')'"></span>
                        <span th:if="${usage.translator != null}" th:text="'(' + #{usage.translator.label} + ': ' + ${usage.translator} + ')'"></span>
                        <button type="button" class="btn badge badge-primary ml-2"
                                th:title="Muuda" th:data-target-elem="${usage.id} + '_usage'"
                                onclick="openEditDlg(this)"
                                data-toggle="modal" data-target="#editDlg">
                          <i class="fa fa-edit" aria-hidden="true"></i>
                        </button>
                        <button type="button" class="btn badge badge-warning"
                                th:data-target-elem="${usage.id} + '_usage'"
                                data-toggle="delete-confirmation" data-placement="right">
                          <i class="fa fa-remove" aria-hidden="true"></i>
                        </button>
                      </div>
                      <div th:unless="${not #lists.isEmpty(usage.refLinks)}">
                        []
                        <button type="button" class="btn badge badge-success" title="Lisa allikaviide"
                                th:data-id="${usage.id}"
                                th:data-op-code="ffSourceRef"
                                onclick="openAddSourceRefDlg(this)"
                                data-toggle="modal" data-target="#addNewSourceRefDlg">
                          <i class="fa fa-plus" aria-hidden="true"></i>
                        </button>
                      </div>
                      <div th:if="${not #lists.isEmpty(usage.refLinks)}" class="hidden-buttons">
                          <span th:each="refLink : ${usage.refLinks}">
                            [
                            <a th:href="@{'/ff_ref_link:' + ${refLink.id}}"
                               th:name="${refLink.id} + '_ff_ref_link'"
                               th:data-id="${refLink.id}"
                               th:data-op-code="ff_ref_link"
                               th:text="${refLink.value}"
                            ></a>
                            <span th:if="${refLink.name != null}">
                              <span th:text="${refLink.name}"></span>
                            </span>
                            <button type="button" class="btn badge badge-warning"
                                    th:data-target-elem="${refLink.id} + '_ff_ref_link'"
                                    data-toggle="delete-confirmation" data-placement="right">
                              <i class="fa fa-remove" aria-hidden="true"></i>
                            </button>
                            ]
                          </span>
                        <button type="button" class="btn badge badge-success" title="Lisa allikaviide"
                                th:data-id="${usage.id}"
                                th:data-op-code="ffSourceRef"
                                onclick="openAddSourceRefDlg(this)"
                                data-toggle="modal" data-target="#addNewSourceRefDlg">
                          <i class="fa fa-plus" aria-hidden="true"></i>
                        </button>
                      </div>
                    </li>
                  </th:block>
                </th:block>
              </ul>
            </div>
            <div th:if="${not #lists.isEmpty(lexeme.freeforms)}">
              <hr />
              <span class="lbl">Ilmiku atribuudid</span>
              <table>
                <tr th:each="freeform : ${lexeme.freeforms}">
                  <td style="vertical-align: text-top; padding-right: 1em">
                    <span th:text="${freeform.type}"></span>
                  </td>
                  <td>
                    <span th:utext="${markdown.toHtml(freeform.valueText)}" th:if="${freeform.valueText != null}"></span>
                    <span th:text="${#dates.format(freeform.valueDate, 'dd.MM.yyyy HH:mm')}" th:if="${freeform.valueDate != null}"></span>
                  </td>
                </tr>
              </table>
            </div>
          </div>
        </th:block>
      </div>
    </div>
    <script th:inline="javascript">
        $('[data-toggle=confirmation]').confirmation(
            {
                btnOkLabel: 'Jah',
                btnCancelLabel: 'Ei'
            }
        );
        $('[data-toggle=delete-confirmation]').confirmation(
            {
                btnOkLabel: 'Jah',
                btnCancelLabel: 'Ei',
                title: 'Kas olete kindel, et soovite eemaldada ?',
                onConfirm: performDelete
            }
        );
        decorateRefLinks();
    </script>
  </th:block>

  <div th:replace="common :: #editDlg"></div>
  <div th:replace="common :: #addNewDefinitionDlg"></div>
  <div th:replace="common :: #addNewUsageDlg"></div>
  <div th:replace="common :: newWordDlg('TERM_SEARCH')"></div>
  <div th:replace="common :: #addNewSourceRefDlg"></div>
  <div th:replace="common :: #detailsDlg"></div>
  <div th:replace="common :: #meaningDomainDlg"></div>
  <div th:replace="common :: #lexemeClassifiersDlg"></div>
  <div th:replace="common :: #addNewGovernmentUsageDlg"></div>

  <script th:inline="javascript">
  	initialise();
  </script>
</body>
</html>
